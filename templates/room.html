{% extends "base.html" %}
{% block title %}Комната {{ room_name }}{% endblock %}
{% block content %}
  <div class="row">
    <div class="col-md-10 offset-md-1">
      <h2 class="mb-3">Комната: {{ room_name }}</h2>

      <div id="messages" class="border rounded p-3 bg-light" style="height: 420px; overflow-y: auto;">
        {% for msg in messages %}
          <div><small class="text-muted">[{{ msg['timestamp'] }}]</small> <strong>{{ msg['nickname'] }}</strong>: {{ msg['message_text'] }}</div>
        {% endfor %}
      </div>

      <div class="mt-3 d-flex gap-2">
        <form action="{{ url_for('send_message', room_name=room_name) }}" method="post" class="flex-grow-1 d-flex gap-2">
          <input name="message" placeholder="Написать сообщение" class="form-control" autocomplete="off" required>
          <button class="btn btn-success">Отправить</button>
        </form>

        <form action="{{ url_for('leave_room') }}" method="post">
          <button class="btn btn-outline-secondary">Выйти из комнаты</button>
        </form>
      </div>
      <div class="mt-2">
        <small class="text-muted">Вы: {{ nickname or "Гость (войдите для отправки)" }}</small>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
const roomName = {{ room_name|tojson }};
const messagesDiv = document.getElementById('messages');

// функция для подгрузки сообщений через JSON
async function loadMessages() {
  try {
    const res = await fetch(`/get_messages/${encodeURIComponent(roomName)}`);
    if (!res.ok) return;
    const data = await res.json();
    // очистим и нарисуем
    messagesDiv.innerHTML = '';
    for (let i = 0; i < data.length; i++) {
      const m = data[i];
      const div = document.createElement('div');
      const time = document.createElement('small');
      time.className = 'text-muted';
      time.textContent = `[${m.time}] `;
      const bold = document.createElement('strong');
      bold.textContent = m.nickname + ': ';
      div.appendChild(time);
      div.appendChild(bold);
      div.appendChild(document.createTextNode(m.text));
      messagesDiv.appendChild(div);
    }
    // прокрутка вниз
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch (e) {
    console.error("Ошибка при обновлении сообщений", e);
  }
}

// polling каждые 2.5 секунды
setInterval(loadMessages, 2500);
// и один раз сразу
loadMessages();
</script>
{% endblock %}
